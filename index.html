<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Dashboard ‚Äî Botalab</title>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  /* ============================================
     Cyberpunk Palette ‚Äî whale-radar Ê∫ñÊã†
     ============================================ */
  :root {
    --neon-green:  #00FF41;
    --neon-cyan:   #00E5FF;
    --neon-red:    #FF0040;
    --neon-yellow: #FFE600;
    --neon-orange: #FF8800;
    --neon-pink:   #FF2D6A;
    --dark-bg:     #0A0A0F;
    --panel-bg:    #111118;
    --card-bg:     #1A1A25;
    --dim-text:    #556677;
    --white-text:  #E0E0E0;
    --price-up:    #00FF41;
    --price-down:  #FF0040;
    --price-flat:  #888888;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--dark-bg);
    color: var(--white-text);
    font-family: 'Consolas', 'Courier New', monospace;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Grid overlay */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      linear-gradient(rgba(0,229,255,.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,.025) 1px, transparent 1px);
    background-size: 60px 60px;
    pointer-events: none; z-index: 0;
  }
  /* Scanlines */
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: repeating-linear-gradient(
      0deg, transparent, transparent 2px,
      rgba(0,0,0,.035) 2px, rgba(0,0,0,.035) 4px);
    pointer-events: none; z-index: 9999;
  }

  /* ============================================ HEADER */
  .header {
    position: relative; z-index: 1;
    background: var(--panel-bg);
    border-bottom: 1px solid rgba(0,229,255,0.15);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-shrink: 0;
  }
  .header-title {
    font-size: 18px;
    font-weight: bold;
    color: var(--neon-cyan);
    text-shadow: 0 0 10px rgba(0,229,255,0.3);
  }
  .header-subtitle {
    font-size: 11px;
    color: var(--dim-text);
    margin-left: 12px;
  }
  .header-right {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .header-btn {
    background: transparent;
    border: 1px solid var(--neon-cyan);
    color: var(--neon-cyan);
    padding: 4px 12px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .header-btn:hover {
    background: rgba(0,229,255,0.15);
    box-shadow: 0 0 8px rgba(0,229,255,0.3);
  }
  .header-btn.active {
    background: rgba(0,229,255,0.2);
    box-shadow: 0 0 10px rgba(0,229,255,0.4);
  }

  /* ============================================ MAIN AREA */
  .main-area {
    position: relative; z-index: 1;
    flex: 1;
    overflow-y: auto;
    padding: 16px;
  }

  /* ============================================ GRID VIEW */
  .grid-view {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 12px;
  }
  .ticker-card {
    background: var(--card-bg);
    border: 1px solid rgba(0,229,255,0.1);
    border-radius: 4px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  .ticker-card:hover {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 15px rgba(0,229,255,0.15);
    transform: translateY(-2px);
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .card-symbol {
    font-size: 16px;
    font-weight: bold;
    color: var(--neon-cyan);
  }
  .card-grade {
    font-size: 13px;
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 3px;
    min-width: 28px;
    text-align: center;
  }
  .grade-A { background: rgba(0,255,65,0.2); color: var(--neon-green); border: 1px solid var(--neon-green); }
  .grade-B { background: rgba(0,229,255,0.2); color: var(--neon-cyan); border: 1px solid var(--neon-cyan); }
  .grade-C { background: rgba(255,230,0,0.2); color: var(--neon-yellow); border: 1px solid var(--neon-yellow); }
  .grade-D { background: rgba(255,136,0,0.2); color: var(--neon-orange); border: 1px solid var(--neon-orange); }
  .grade-E { background: rgba(255,0,64,0.2); color: var(--neon-red); border: 1px solid var(--neon-red); }
  .card-name {
    font-size: 11px;
    color: var(--dim-text);
    margin-bottom: 10px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .card-price {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 4px;
  }
  .card-change {
    font-size: 13px;
    font-weight: bold;
  }
  .card-watchstar {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 16px;
    cursor: pointer;
    opacity: 0.3;
    transition: opacity 0.2s;
    z-index: 2;
  }
  .card-watchstar:hover { opacity: 0.7; }
  .card-watchstar.watched { opacity: 1; color: var(--neon-yellow); }
  .up { color: var(--price-up); }
  .down { color: var(--price-down); }
  .flat { color: var(--price-flat); }

  /* ============================================ FILTER BAR */
  .filter-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .filter-btn {
    background: transparent;
    border: 1px solid rgba(0,229,255,0.3);
    color: var(--dim-text);
    padding: 3px 10px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-btn:hover { color: var(--neon-cyan); border-color: var(--neon-cyan); }
  .filter-btn.active { color: var(--neon-cyan); border-color: var(--neon-cyan); background: rgba(0,229,255,0.1); }
  .filter-label {
    font-size: 11px;
    color: var(--dim-text);
    margin-right: 4px;
  }

  /* ============================================ DETAIL VIEW */
  .detail-view {
    display: none;
    flex-direction: column;
    height: 100%;
  }
  .detail-view.active {
    display: flex;
  }
  .detail-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .back-btn {
    background: transparent;
    border: 1px solid var(--neon-cyan);
    color: var(--neon-cyan);
    padding: 4px 12px;
    font-family: inherit;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .back-btn:hover {
    background: rgba(0,229,255,0.15);
  }
  .detail-symbol {
    font-size: 22px;
    font-weight: bold;
    color: var(--neon-cyan);
    text-shadow: 0 0 10px rgba(0,229,255,0.3);
  }
  .detail-name {
    font-size: 14px;
    color: var(--dim-text);
  }
  .detail-price-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-left: auto;
  }
  .detail-price {
    font-size: 26px;
    font-weight: bold;
  }
  .detail-change {
    font-size: 15px;
    font-weight: bold;
  }
  .detail-grade-badge {
    font-size: 18px;
    font-weight: bold;
    padding: 4px 14px;
    border-radius: 4px;
  }
  .detail-watch-btn {
    background: transparent;
    border: 1px solid var(--neon-yellow);
    color: var(--neon-yellow);
    padding: 4px 10px;
    font-family: inherit;
    font-size: 12px;
    cursor: pointer;
    opacity: 0.5;
    transition: all 0.2s;
  }
  .detail-watch-btn.watched {
    opacity: 1;
    background: rgba(255,230,0,0.15);
  }

  /* ============================================ DETAIL PANELS */
  .detail-panels {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    gap: 12px;
    flex: 1;
    min-height: 0;
  }
  .panel {
    background: var(--card-bg);
    border: 1px solid rgba(0,229,255,0.1);
    border-radius: 4px;
    padding: 12px;
    display: flex;
    flex-direction: column;
    overflow: auto;
  }
  .panel-title {
    font-size: 12px;
    font-weight: bold;
    color: var(--neon-cyan);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
    flex-shrink: 0;
  }
  .panel-body {
    flex: 1;
    overflow: auto;
    min-height: 0;
  }

  /* ============================================ CHART PANEL */
  #chartContainer {
    width: 100%;
    height: 100%;
    min-height: 200px;
  }
  .period-btns {
    display: flex;
    gap: 4px;
    margin-bottom: 6px;
    flex-shrink: 0;
  }
  .period-btn {
    background: transparent;
    border: 1px solid rgba(0,229,255,0.3);
    color: var(--dim-text);
    padding: 2px 8px;
    font-family: inherit;
    font-size: 11px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .period-btn:hover { color: var(--neon-cyan); border-color: var(--neon-cyan); }
  .period-btn.active { color: var(--neon-cyan); border-color: var(--neon-cyan); background: rgba(0,229,255,0.15); }

  /* ============================================ INFO PANEL */
  .info-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 6px 12px;
  }
  .info-item {
    display: flex;
    flex-direction: column;
    padding: 4px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .info-label {
    font-size: 10px;
    color: var(--dim-text);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .info-value {
    font-size: 13px;
    color: var(--white-text);
    font-weight: bold;
  }
  .info-summary {
    font-size: 11px;
    color: var(--dim-text);
    line-height: 1.5;
    margin-top: 8px;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding-top: 8px;
  }

  /* ============================================ RADAR PANEL */
  .radar-wrap {
    display: flex;
    align-items: flex-start;
    gap: 14px;
    height: 100%;
    overflow: auto;
  }
  .radar-chart-area {
    flex: 1;
    min-width: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .radar-chart-area canvas {
    max-width: 260px;
    max-height: 260px;
  }
  .score-card {
    flex-shrink: 0;
    width: 150px;
  }
  .score-total {
    text-align: center;
    margin-bottom: 10px;
  }
  .score-total-num {
    font-size: 36px;
    font-weight: bold;
    color: var(--neon-cyan);
    text-shadow: 0 0 15px rgba(0,229,255,0.4);
  }
  .score-total-label {
    font-size: 10px;
    color: var(--dim-text);
  }
  .score-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    font-size: 11px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    white-space: nowrap;
  }
  .score-cat { color: var(--dim-text); }
  .score-val { color: var(--neon-green); font-weight: bold; min-width: 30px; text-align: right; }
  .score-detail {
    font-size: 10px;
    color: var(--dim-text);
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid rgba(255,255,255,0.08);
    line-height: 1.6;
  }
  .score-detail-item {
    margin-bottom: 4px;
  }
  .score-detail-label {
    color: var(--neon-cyan);
    font-weight: bold;
  }

  /* ============================================ ALERTS PANEL */
  .alerts-layout {
    display: flex;
    gap: 12px;
    height: 100%;
  }
  .alerts-timeline {
    flex: 1;
    overflow-y: auto;
    min-width: 0;
  }
  .alert-item {
    padding: 6px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .alert-time {
    font-size: 10px;
    color: var(--dim-text);
  }
  .alert-type {
    font-size: 11px;
    font-weight: bold;
    margin: 2px 0;
  }
  .alert-type.high { color: var(--neon-red); }
  .alert-type.medium { color: var(--neon-orange); }
  .alert-type.low { color: var(--neon-yellow); }
  .alert-desc {
    font-size: 11px;
    color: var(--dim-text);
  }
  .alert-section-header {
    font-size: 11px;
    font-weight: bold;
    color: var(--neon-cyan);
    padding: 6px 0 3px;
    border-bottom: 1px solid rgba(0,229,255,0.15);
    margin-top: 6px;
  }
  .sentiment-bar-wrap {
    margin: 8px 0;
    padding: 6px 0;
    border-top: 1px solid rgba(255,255,255,0.05);
  }
  .sentiment-label {
    font-size: 10px;
    color: var(--dim-text);
    margin-bottom: 4px;
  }
  .sentiment-bar {
    display: flex;
    height: 10px;
    border-radius: 3px;
    overflow: hidden;
    background: #222;
  }
  .sentiment-bar .bull { background: var(--neon-green); }
  .sentiment-bar .bear { background: var(--neon-red); }
  .sentiment-bar-labels {
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    margin-top: 2px;
  }
  .whale-error {
    color: var(--dim-text);
    font-size: 12px;
    text-align: center;
    padding: 20px;
  }
  .alerts-chart-area {
    flex-shrink: 0;
    width: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .alerts-chart-area canvas {
    max-width: 150px;
    max-height: 150px;
  }

  /* ============================================ LOADING */
  .loading-overlay {
    position: absolute;
    inset: 0;
    background: rgba(10,10,15,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
  }
  .loading-spinner {
    color: var(--neon-cyan);
    font-size: 14px;
    animation: pulse 1s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  /* ============================================ TICKER CONFIG OVERLAY */
  .tkcfg-overlay {
    position: fixed; inset: 0; z-index: 8500;
    background: rgba(10,10,15,.92);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; pointer-events: none;
    transition: opacity 0.25s ease;
  }
  .tkcfg-overlay.show { opacity: 1; pointer-events: auto; }
  .tkcfg-box {
    background: var(--panel-bg);
    border: 2px solid var(--neon-cyan);
    border-radius: 12px;
    width: 500px; max-width: 95vw; max-height: 85vh;
    display: flex; flex-direction: column;
    box-shadow: 0 0 40px rgba(0,229,255,.15);
    overflow: hidden;
  }
  .tkcfg-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 16px; border-bottom: 1px solid #2A2A3A;
  }
  .tkcfg-header h3 { font-size: 15px; font-weight: bold; color: var(--neon-green); margin: 0; }
  .tkcfg-close {
    font-size: 18px; color: var(--dim-text); cursor: pointer;
    background: none; border: none;
    font-family: 'Consolas', 'Courier New', monospace;
    padding: 2px 8px; border-radius: 4px;
  }
  .tkcfg-close:hover { color: var(--neon-red); }
  .tkcfg-add {
    display: flex; gap: 6px; padding: 10px 16px;
    border-bottom: 1px solid #2A2A3A; background: rgba(0,255,65,.03);
  }
  .tkcfg-add input {
    flex: 1; padding: 8px 12px; background: var(--card-bg);
    border: 1px solid #2A2A3A; border-radius: 6px;
    color: var(--white-text);
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 14px; text-transform: uppercase; outline: none;
  }
  .tkcfg-add input:focus { border-color: var(--neon-green); box-shadow: 0 0 6px rgba(0,255,65,.2); }
  .tkcfg-add input::placeholder { color: #444; text-transform: none; }
  .tkcfg-add-btn {
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 13px; font-weight: bold; padding: 8px 18px;
    border-radius: 6px; cursor: pointer;
    border: 2px solid var(--neon-green); color: var(--neon-green);
    background: #002200; white-space: nowrap; transition: background .2s;
  }
  .tkcfg-add-btn:hover { background: #003300; }
  .tkcfg-msg { font-size: 11px; padding: 4px 16px; min-height: 20px; }
  .tkcfg-msg.ok { color: var(--neon-green); }
  .tkcfg-msg.err { color: var(--neon-red); }
  .tkcfg-list { flex: 1; min-height: 0; overflow-y: auto; padding: 6px 12px; }
  .tkcfg-list::-webkit-scrollbar { width: 4px; }
  .tkcfg-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
  .tkcfg-item {
    display: flex; align-items: center; padding: 7px 10px;
    background: var(--card-bg); border-radius: 6px; margin-bottom: 3px;
    transition: background .15s;
  }
  .tkcfg-item:hover { background: rgba(0,229,255,.04); }
  .tkcfg-item-name { flex: 1; font-size: 14px; font-weight: bold; color: var(--neon-green); }
  .tkcfg-del {
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 11px; font-weight: bold; padding: 3px 12px;
    border-radius: 4px; cursor: pointer;
    border: 1px solid var(--neon-red); color: var(--neon-red);
    background: transparent; transition: all .2s; white-space: nowrap;
  }
  .tkcfg-del:hover { background: rgba(255,0,64,.15); color: #FF4070; }
  .tkcfg-count {
    text-align: center; font-size: 10px; color: var(--dim-text);
    padding: 6px 0; border-top: 1px solid #2A2A3A;
  }
  .tkcfg-count .cy { color: var(--neon-cyan); font-weight: bold; }

  /* ============================================ RESPONSIVE */
  @media (max-width: 1024px) {
    .grid-view {
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    }
    .detail-panels {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
    }
    .panel { min-height: 250px; }
    .radar-wrap { flex-direction: column; }
    .score-card { width: 100%; }
    .alerts-layout { flex-direction: column; }
    .alerts-chart-area { width: 100%; height: 160px; }
  }
  @media (max-width: 600px) {
    .grid-view {
      grid-template-columns: 1fr;
    }
    .header { padding: 8px 12px; }
    .header-title { font-size: 14px; }
    .detail-header { flex-direction: column; align-items: flex-start; }
    .detail-price-row { margin-left: 0; }
    .info-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<!-- ============================================ HEADER -->
<div class="header">
  <div style="display:flex;align-items:center;gap:10px;">
    <span class="header-title">STOCK DASHBOARD</span>
    <span class="header-subtitle">„Éï„Ç°„É≥„ÉÄ„É°„É≥„Çø„É´„Ç∫ & „ÇØ„Ç∏„É©Ê¥ªÂãï</span>
    <a href="https://bota-labo.blog/whale-radar/" target="_blank" rel="noopener"
       style="font-size:11px; padding:3px 10px; border:1px solid #00e5ff; border-radius:6px;
              color:#00e5ff; text-decoration:none; white-space:nowrap;
              transition:background 0.2s, color 0.2s;"
       onmouseover="this.style.background='#00e5ff';this.style.color='#000'"
       onmouseout="this.style.background='transparent';this.style.color='#00e5ff'"
    >&#x1F40B; „ÇØ„Ç∏„É©„É¨„Éº„ÉÄ„Éº</a>
  </div>
  <div class="header-right">
    <button class="header-btn" onclick="openTickerConfig()">&#x2699; ÈäòÊüÑË®≠ÂÆö</button>
    <button class="header-btn" id="filterAll" onclick="setFilter('all')">„Åô„Åπ„Å¶</button>
    <button class="header-btn" id="filterWatch" onclick="setFilter('watchlist')">„ÅäÊ∞ó„Å´ÂÖ•„Çä</button>
    <span style="font-size:11px;color:var(--dim-text);" id="lastUpdate"></span>
  </div>
</div>

<!-- ============================================ MAIN -->
<div class="main-area" id="mainArea">

  <!-- GRID VIEW -->
  <div id="gridView">
    <div class="filter-bar">
      <span class="filter-label">‰∏¶„Å≥Êõø„Åà:</span>
      <button class="filter-btn active" id="sortSymbol" onclick="setSort('symbol')">ÈäòÊüÑ</button>
      <button class="filter-btn" id="sortChange" onclick="setSort('change')">Â§âÂãïÁéá</button>
      <button class="filter-btn" id="sortGrade" onclick="setSort('grade')">„Ç∞„É¨„Éº„Éâ</button>
    </div>
    <div class="grid-view" id="tickerGrid">
      <div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--neon-cyan);">
        <div class="loading-spinner" style="font-size:16px;">ÈäòÊüÑ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...</div>
      </div>
    </div>
  </div>

  <!-- DETAIL VIEW -->
  <div class="detail-view" id="detailView">
    <div class="detail-header">
      <button class="back-btn" onclick="showGrid()">‚Üê Êàª„Çã</button>
      <span class="detail-symbol" id="detailSymbol"></span>
      <span class="detail-name" id="detailName"></span>
      <span class="detail-grade-badge" id="detailGradeBadge"></span>
      <button class="detail-watch-btn" id="detailWatchBtn" onclick="toggleWatchDetail()">‚òÖ ÁôªÈå≤</button>
      <div class="detail-price-row">
        <span class="detail-price" id="detailPrice"></span>
        <span class="detail-change" id="detailChange"></span>
      </div>
    </div>

    <div class="detail-panels">
      <!-- Chart Panel -->
      <div class="panel">
        <div class="panel-title">Ê†™‰æ°„ÉÅ„É£„Éº„Éà</div>
        <div class="period-btns">
          <button class="period-btn" onclick="setPeriod('1mo')">1M</button>
          <button class="period-btn active" onclick="setPeriod('3mo')">3M</button>
          <button class="period-btn" onclick="setPeriod('6mo')">6M</button>
          <button class="period-btn" onclick="setPeriod('1y')">1Y</button>
          <button class="period-btn" onclick="setPeriod('2y')">2Y</button>
        </div>
        <div class="panel-body">
          <div id="chartContainer"></div>
        </div>
      </div>

      <!-- Company Info Panel -->
      <div class="panel">
        <div class="panel-title">‰ºÅÊ•≠ÊÉÖÂ†±</div>
        <div class="panel-body" id="infoPanel"></div>
      </div>

      <!-- Fundamentals Radar Panel -->
      <div class="panel">
        <div class="panel-title">„Éï„Ç°„É≥„ÉÄ„É°„É≥„Çø„É´„Ç∫</div>
        <div class="panel-body">
          <div class="radar-wrap">
            <div class="radar-chart-area">
              <canvas id="radarCanvas"></canvas>
            </div>
            <div class="score-card" id="scoreCard"></div>
          </div>
        </div>
      </div>

      <!-- Whale Alerts Panel -->
      <div class="panel">
        <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
          <span>üêã „ÇØ„Ç∏„É©„Ç¢„É©„Éº„Éà</span>
          <span id="whaleScanTime" style="font-size:10px;color:var(--dim-text);text-transform:none;letter-spacing:0;"></span>
        </div>
        <div class="panel-body">
          <div class="alerts-layout">
            <div class="alerts-timeline" id="alertsTimeline"></div>
            <div class="alerts-chart-area">
              <canvas id="alertsPieCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======== TICKER CONFIG OVERLAY ======== -->
<div class="tkcfg-overlay" id="tkcfgOverlay" onclick="if(event.target===this)closeTickerConfig()">
  <div class="tkcfg-box">
    <div class="tkcfg-header">
      <h3>&#x2699; ÈäòÊüÑ„ÅÆËøΩÂä†„ÉªÂâäÈô§</h3>
      <button class="tkcfg-close" onclick="closeTickerConfig()">&#x2715;</button>
    </div>
    <div class="tkcfg-add">
      <input type="text" id="tkcfgInput" placeholder="&#x2795; „ÉÜ„Ç£„ÉÉ„Ç´„Éº„ÇíÂÖ•Âäõ (‰æã: AAPL)" maxlength="10" autocomplete="off"
             onkeydown="if(event.key==='Enter')addTickerFromInput()">
      <button class="tkcfg-add-btn" onclick="addTickerFromInput()">&#x2795; ËøΩÂä†</button>
    </div>
    <div class="tkcfg-msg" id="tkcfgMsg"></div>
    <div class="tkcfg-list" id="tkcfgList"></div>
    <div class="tkcfg-count" id="tkcfgCount"></div>
  </div>
</div>

<script>
// ============================================
// State
// ============================================
let tickersData = [];
let watchlist = [];
let tickerList = [];
let currentFilter = 'all';
let currentSort = 'symbol';
let currentSymbol = null;
let currentPeriod = '3mo';
let lwChart = null;
let candleSeries = null;
let volumeSeries = null;
let radarChart = null;
let pieChart = null;
let refreshTimer = null;
let whaleRefreshTimer = null;

// ============================================
// API helpers
// ============================================
const API = '';

async function fetchJSON(url) {
  try {
    const res = await fetch(API + url);
    if (!res.ok) return null;
    return await res.json();
  } catch (e) {
    console.error('Fetch error:', url, e);
    return null;
  }
}

// ============================================
// Grid View
// ============================================
async function loadTickers() {
  const data = await fetchJSON('/api/tickers');
  if (!data) {
    document.getElementById('tickerGrid').innerHTML =
      '<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--neon-red);">APIÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å‰∏≠...</div>';
    return;
  }
  tickersData = data.tickers || [];
  watchlist = data.watchlist || [];
  tickerList = data.tickerList || tickersData.map(t => t.symbol);
  renderGrid();
  document.getElementById('lastUpdate').textContent =
    'ÊúÄÁµÇÊõ¥Êñ∞: ' + new Date().toLocaleTimeString('ja-JP');
}

function renderGrid() {
  const grid = document.getElementById('tickerGrid');
  let items = [...tickersData];

  // Filter
  if (currentFilter === 'watchlist') {
    items = items.filter(t => watchlist.includes(t.symbol));
  }

  // Sort
  if (currentSort === 'symbol') {
    items.sort((a, b) => a.symbol.localeCompare(b.symbol));
  } else if (currentSort === 'change') {
    items.sort((a, b) => b.changePct - a.changePct);
  } else if (currentSort === 'grade') {
    const order = { A: 0, B: 1, C: 2, D: 3, E: 4, '': 5 };
    items.sort((a, b) => (order[a.grade] ?? 5) - (order[b.grade] ?? 5));
  }

  grid.innerHTML = items.map(t => {
    const cls = t.changePct > 0 ? 'up' : t.changePct < 0 ? 'down' : 'flat';
    const sign = t.changePct > 0 ? '+' : '';
    const isWatched = watchlist.includes(t.symbol);
    const gradeCls = t.grade ? `grade-${t.grade}` : '';
    return `
      <div class="ticker-card" onclick="showDetail('${t.symbol}')">
        <span class="card-watchstar ${isWatched ? 'watched' : ''}"
              onclick="event.stopPropagation(); toggleWatch('${t.symbol}')">‚òÖ</span>
        <div class="card-header">
          <span class="card-symbol">${t.symbol}</span>
          ${t.grade ? `<span class="card-grade ${gradeCls}">${t.grade}</span>` : ''}
        </div>
        <div class="card-name">${t.name}</div>
        <div class="card-price ${cls}">${t.price > 0 ? '$' + t.price.toFixed(2) : '<span style="color:var(--dim-text)">ÂèñÂæó‰∏≠...</span>'}</div>
        <div class="card-change ${cls}">${t.price > 0 ? sign + t.change.toFixed(2) + ' (' + sign + t.changePct.toFixed(2) + '%)' : ''}</div>
      </div>
    `;
  }).join('');
}

// ============================================
// Filter & Sort
// ============================================
function setFilter(f) {
  currentFilter = f;
  document.getElementById('filterAll').classList.toggle('active', f === 'all');
  document.getElementById('filterWatch').classList.toggle('active', f === 'watchlist');
  renderGrid();
}

function setSort(s) {
  currentSort = s;
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.id === 'sort' + s.charAt(0).toUpperCase() + s.slice(1));
  });
  renderGrid();
}

// ============================================
// Watchlist
// ============================================
async function toggleWatch(symbol) {
  const action = watchlist.includes(symbol) ? 'remove' : 'add';
  const data = await fetchJSON('/api/watchlist');  // pre-check
  await fetch(API + '/api/watchlist', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ symbol, action }),
  });
  const res = await fetchJSON('/api/watchlist');
  if (res) watchlist = res.watchlist;
  renderGrid();
}

function toggleWatchDetail() {
  if (!currentSymbol) return;
  toggleWatch(currentSymbol).then(() => {
    const btn = document.getElementById('detailWatchBtn');
    btn.classList.toggle('watched', watchlist.includes(currentSymbol));
    btn.textContent = watchlist.includes(currentSymbol) ? '‚òÖ ÁôªÈå≤Ê∏à' : '‚òÖ ÁôªÈå≤';
  });
}

// ============================================
// Detail View
// ============================================
async function showDetail(symbol) {
  currentSymbol = symbol;
  document.getElementById('gridView').style.display = 'none';
  document.getElementById('detailView').classList.add('active');

  // Set header immediately with cached data
  const cached = tickersData.find(t => t.symbol === symbol);
  if (cached) {
    setDetailHeader(cached.symbol, cached.name, cached.price, cached.change, cached.changePct, cached.grade || '');
  }

  // Fetch full detail, chart, and whale alerts in parallel
  const [detail, chartData, whaleData] = await Promise.all([
    fetchJSON(`/api/detail/${symbol}`),
    fetchJSON(`/api/chart/${symbol}?period=${currentPeriod}`),
    fetchJSON(`/api/whale-alerts/${symbol}`),
  ]);

  if (detail) {
    setDetailHeader(
      detail.symbol, detail.name,
      detail.price || (cached && cached.price) || 0,
      detail.change || 0, detail.changePct || 0,
      detail.fundamentals?.grade || ''
    );
    renderInfoPanel(detail);
    renderRadarChart(detail.fundamentals);
  }

  if (chartData && chartData.data) {
    renderCandlestick(chartData.data);
  }

  renderWhaleAlerts(whaleData);

  // „ÇØ„Ç∏„É©„Ç¢„É©„Éº„ÉàËá™ÂãïÊõ¥Êñ∞ (5ÂàÜ„Åî„Å®)
  if (whaleRefreshTimer) clearInterval(whaleRefreshTimer);
  whaleRefreshTimer = setInterval(async () => {
    if (!currentSymbol) return;
    const wd = await fetchJSON(`/api/whale-alerts/${currentSymbol}`);
    renderWhaleAlerts(wd);
  }, 300000);

  // Update watchlist button state
  const btn = document.getElementById('detailWatchBtn');
  btn.classList.toggle('watched', watchlist.includes(symbol));
  btn.textContent = watchlist.includes(symbol) ? '‚òÖ ÁôªÈå≤Ê∏à' : '‚òÖ ÁôªÈå≤';
}

function setDetailHeader(symbol, name, price, change, changePct, grade) {
  document.getElementById('detailSymbol').textContent = symbol;
  document.getElementById('detailName').textContent = name;

  const priceEl = document.getElementById('detailPrice');
  const changeEl = document.getElementById('detailChange');
  const cls = changePct > 0 ? 'up' : changePct < 0 ? 'down' : 'flat';
  const sign = changePct > 0 ? '+' : '';
  priceEl.textContent = '$' + price.toFixed(2);
  priceEl.className = 'detail-price ' + cls;
  changeEl.textContent = `${sign}${change.toFixed(2)} (${sign}${changePct.toFixed(2)}%)`;
  changeEl.className = 'detail-change ' + cls;

  const badge = document.getElementById('detailGradeBadge');
  if (grade) {
    badge.textContent = grade;
    badge.className = `detail-grade-badge grade-${grade}`;
    badge.style.display = '';
  } else {
    badge.style.display = 'none';
  }
}

function showGrid() {
  document.getElementById('detailView').classList.remove('active');
  document.getElementById('gridView').style.display = '';
  currentSymbol = null;
  if (lwChart) {
    lwChart.remove();
    lwChart = null;
    candleSeries = null;
    volumeSeries = null;
  }
  if (whaleRefreshTimer) {
    clearInterval(whaleRefreshTimer);
    whaleRefreshTimer = null;
  }
}

// ============================================
// Period switch
// ============================================
async function setPeriod(period) {
  currentPeriod = period;
  document.querySelectorAll('.period-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.toLowerCase().replace(' ', '') === period);
  });
  if (!currentSymbol) return;
  const chartData = await fetchJSON(`/api/chart/${currentSymbol}?period=${period}`);
  if (chartData && chartData.data) {
    renderCandlestick(chartData.data);
  }
}

// ============================================
// Candlestick Chart (Lightweight Charts)
// ============================================
function renderCandlestick(data) {
  const container = document.getElementById('chartContainer');

  if (lwChart) {
    lwChart.remove();
    lwChart = null;
  }

  if (!data || data.length === 0) {
    container.innerHTML = '<div style="color:var(--dim-text);text-align:center;padding:40px;">„ÉÅ„É£„Éº„Éà„Éá„Éº„Çø„Å™„Åó</div>';
    return;
  }

  lwChart = LightweightCharts.createChart(container, {
    width: container.clientWidth,
    height: container.clientHeight,
    layout: {
      background: { color: '#1A1A25' },
      textColor: '#556677',
      fontFamily: "'Consolas', monospace",
      fontSize: 11,
    },
    grid: {
      vertLines: { color: 'rgba(0,229,255,0.05)' },
      horzLines: { color: 'rgba(0,229,255,0.05)' },
    },
    crosshair: {
      mode: LightweightCharts.CrosshairMode.Normal,
    },
    rightPriceScale: {
      borderColor: 'rgba(0,229,255,0.15)',
    },
    timeScale: {
      borderColor: 'rgba(0,229,255,0.15)',
      timeVisible: true,
    },
  });

  candleSeries = lwChart.addCandlestickSeries({
    upColor: '#00FF41',
    downColor: '#FF0040',
    borderUpColor: '#00FF41',
    borderDownColor: '#FF0040',
    wickUpColor: '#00FF41',
    wickDownColor: '#FF0040',
  });

  candleSeries.setData(data.map(d => ({
    time: d.time,
    open: d.open,
    high: d.high,
    low: d.low,
    close: d.close,
  })));

  volumeSeries = lwChart.addHistogramSeries({
    priceFormat: { type: 'volume' },
    priceScaleId: 'volume',
  });

  lwChart.priceScale('volume').applyOptions({
    scaleMargins: { top: 0.8, bottom: 0 },
  });

  volumeSeries.setData(data.map(d => ({
    time: d.time,
    value: d.volume,
    color: d.close >= d.open ? 'rgba(0,255,65,0.3)' : 'rgba(255,0,64,0.3)',
  })));

  lwChart.timeScale().fitContent();

  // Resize observer
  const ro = new ResizeObserver(() => {
    if (lwChart) {
      lwChart.applyOptions({
        width: container.clientWidth,
        height: container.clientHeight,
      });
    }
  });
  ro.observe(container);
}

// ============================================
// Company Info Panel
// ============================================
function renderInfoPanel(detail) {
  const panel = document.getElementById('infoPanel');

  function fmt(val, suffix = '') {
    if (val === null || val === undefined) return 'N/A';
    if (typeof val === 'number') {
      if (Math.abs(val) >= 1e12) return (val / 1e12).toFixed(2) + 'T' + suffix;
      if (Math.abs(val) >= 1e9) return (val / 1e9).toFixed(2) + 'B' + suffix;
      if (Math.abs(val) >= 1e6) return (val / 1e6).toFixed(2) + 'M' + suffix;
      return val.toFixed(2) + suffix;
    }
    return val + suffix;
  }

  function pct(val) {
    if (val === null || val === undefined) return 'N/A';
    return (val * 100).toFixed(2) + '%';
  }

  const items = [
    ['„Çª„ÇØ„Çø„Éº', detail.sector],
    ['Ê•≠Á®Æ', detail.industry],
    ['ÊôÇ‰æ°Á∑èÈ°ç', fmt(detail.marketCap)],
    ['‰ºÅÊ•≠‰æ°ÂÄ§(EV)', fmt(detail.enterpriseValue)],
    ['P/E (ÂÆüÁ∏æ)', fmt(detail.trailingPE)],
    ['P/E (‰∫àÊÉ≥)', fmt(detail.forwardPE)],
    ['P/B', fmt(detail.priceToBook)],
    ['ÈÖçÂΩìÂà©Âõû„Çä', pct(detail.dividendYield)],
    ['52ÈÄ± È´òÂÄ§', '$' + fmt(detail.fiftyTwoWeekHigh)],
    ['52ÈÄ± ÂÆâÂÄ§', '$' + fmt(detail.fiftyTwoWeekLow)],
    ['Âπ≥ÂùáÂá∫Êù•È´ò', fmt(detail.averageVolume)],
    ['Beta', fmt(detail.beta)],
    ['Âà©ÁõäÁéá', pct(detail.profitMargins)],
    ['ROE', pct(detail.returnOnEquity)],
    ['Â£≤‰∏äÊàêÈï∑Áéá', pct(detail.revenueGrowth)],
    ['Âà©ÁõäÊàêÈï∑Áéá', pct(detail.earningsGrowth)],
    ['D/EÊØîÁéá', fmt(detail.debtToEquity)],
    ['ÊµÅÂãïÊØîÁéá', fmt(detail.currentRatio)],
  ];

  panel.innerHTML = `
    <div class="info-grid">
      ${items.map(([label, value]) => `
        <div class="info-item">
          <span class="info-label">${label}</span>
          <span class="info-value">${value}</span>
        </div>
      `).join('')}
    </div>
    ${detail.longBusinessSummary ? `<div class="info-summary">${detail.longBusinessSummary}</div>` : ''}
  `;
}

// ============================================
// Radar Chart (Chart.js)
// ============================================
function renderRadarChart(fund) {
  if (!fund) return;

  const canvas = document.getElementById('radarCanvas');
  if (radarChart) {
    radarChart.destroy();
    radarChart = null;
  }

  const cats = fund.categories || {};
  const labels = ['ÂèéÁõäÊÄß', 'ÊàêÈï∑ÊÄß', 'ÂÅ•ÂÖ®ÊÄß', '„Éê„É™„É•„Éº', '„É¢„É°„É≥„Çø„É†'];
  const keys = ['profitability', 'growth', 'health', 'value', 'momentum'];
  const values = keys.map(k => cats[k] || 0);

  radarChart = new Chart(canvas, {
    type: 'radar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Score',
        data: values,
        backgroundColor: 'rgba(0,229,255,0.15)',
        borderColor: '#00FF41',
        borderWidth: 2,
        pointBackgroundColor: '#00E5FF',
        pointBorderColor: '#00FF41',
        pointRadius: 4,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
      },
      scales: {
        r: {
          beginAtZero: true,
          max: 100,
          ticks: {
            stepSize: 20,
            color: '#556677',
            backdropColor: 'transparent',
            font: { size: 10, family: "'Consolas', monospace" },
          },
          grid: {
            color: 'rgba(0,229,255,0.1)',
          },
          angleLines: {
            color: 'rgba(0,229,255,0.1)',
          },
          pointLabels: {
            color: '#E0E0E0',
            font: { size: 11, family: "'Consolas', monospace" },
          },
        },
      },
    },
  });

  // Score card
  const card = document.getElementById('scoreCard');
  const gradeClass = fund.grade ? `grade-${fund.grade}` : '';
  const reasons = fund.reasons || {};

  const catLabelsJP = {
    profitability: 'ÂèéÁõäÊÄß',
    growth: 'ÊàêÈï∑ÊÄß',
    health: 'ÂÅ•ÂÖ®ÊÄß',
    value: '„Éê„É™„É•„Éº',
    momentum: '„É¢„É°„É≥„Çø„É†',
  };
  const weightLabels = {
    profitability: '25%',
    growth: '25%',
    health: '20%',
    value: '15%',
    momentum: '15%',
  };

  card.innerHTML = `
    <div class="score-total">
      <div class="score-total-num">${fund.score}</div>
      <div class="score-total-label">/ 100</div>
      <div class="card-grade ${gradeClass}" style="display:inline-block;margin-top:6px;font-size:20px;">
        ${fund.grade}
      </div>
    </div>
    ${keys.map((k, i) => `
      <div class="score-row">
        <span class="score-cat">${labels[i]} <span style="color:#444;font-size:9px;">(${weightLabels[k]})</span></span>
        <span class="score-val">${(cats[k] || 0).toFixed(0)}</span>
      </div>
    `).join('')}
    <div class="score-detail">
      <div style="color:var(--neon-cyan);font-weight:bold;margin-bottom:4px;">„Çπ„Ç≥„Ç¢Ê†πÊã†</div>
      ${keys.map(k => {
        const r = reasons[k] || {};
        const entries = Object.entries(r).filter(([_, v]) => v !== 'N/A');
        if (entries.length === 0) return '';
        return `<div class="score-detail-item">
          <span class="score-detail-label">${catLabelsJP[k]}:</span>
          ${entries.map(([label, val]) => `${label} ${val}`).join(' / ')}
        </div>`;
      }).join('')}
      <div style="margin-top:6px;color:#445566;font-size:9px;">
        A‚â•80 B‚â•60 C‚â•40 D‚â•20 E&lt;20
      </div>
    </div>
  `;
}

// ============================================
// Whale Alerts (Whale Radar ÈÄ£Êê∫)
// ============================================
function renderWhaleAlerts(data) {
  const timeline = document.getElementById('alertsTimeline');
  const scanTimeEl = document.getElementById('whaleScanTime');

  // „Ç®„É©„Éº„Åæ„Åü„ÅØÊú™Êé•Á∂ö
  if (!data || data.error) {
    const msg = data?.error || '„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó';
    timeline.innerHTML = `<div class="whale-error">${msg}<br><span style="font-size:10px;">‰ªñ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„ÅØÊ≠£Â∏∏„Å´Âà©Áî®„Åß„Åç„Åæ„Åô</span></div>`;
    scanTimeEl.textContent = '';
    renderWhalePie({});
    return;
  }

  // ÊúÄÁµÇ„Çπ„Ç≠„É£„É≥ÊôÇÂàª
  if (data.last_scan_at) {
    try {
      const d = new Date(data.last_scan_at);
      scanTimeEl.textContent = 'ÊúÄÁµÇ„Çπ„Ç≠„É£„É≥: ' + d.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
    } catch(e) { scanTimeEl.textContent = ''; }
  }

  const whaleAlerts = data.whale_alerts || [];
  const spoofingAlerts = data.spoofing_alerts || [];
  const insiderAlerts = data.insider_alerts || [];
  const sentiment = data.sentiment || {};
  const stats = data.stats || {};

  let html = '';

  // „Ç™„Éó„Ç∑„Éß„É≥Áï∞Â∏∏„Çª„ÇØ„Ç∑„Éß„É≥
  if (whaleAlerts.length > 0) {
    html += `<div class="alert-section-header">‚îÄ‚îÄ „Ç™„Éó„Ç∑„Éß„É≥Áï∞Â∏∏ (${whaleAlerts.length}‰ª∂) ‚îÄ‚îÄ</div>`;
    whaleAlerts.forEach(a => {
      const color = a.sentiment === 'up' ? 'var(--neon-green)' : a.sentiment === 'down' ? 'var(--neon-red)' : 'var(--dim-text)';
      html += `
        <div class="alert-item">
          <div class="alert-time">${a.detected_at || ''}</div>
          <div style="font-size:11px;color:${color};font-weight:bold;">${a.text_jp || a.type}</div>
        </div>`;
    });
  }

  // Áï∞Â∏∏Êùø„Çª„ÇØ„Ç∑„Éß„É≥
  if (spoofingAlerts.length > 0) {
    html += `<div class="alert-section-header">‚îÄ‚îÄ Áï∞Â∏∏Êùø„ÉªË¶ã„ÅõÊùø (${spoofingAlerts.length}‰ª∂) ‚îÄ‚îÄ</div>`;
    spoofingAlerts.forEach(a => {
      html += `
        <div class="alert-item">
          <div class="alert-time">${a.detected_at || ''}</div>
          <div style="font-size:11px;color:var(--neon-orange);font-weight:bold;">${a.text_jp || a.type}</div>
        </div>`;
    });
  }

  // „Ç§„É≥„Çµ„Ç§„ÉÄ„Éº„Çª„ÇØ„Ç∑„Éß„É≥
  if (insiderAlerts.length > 0) {
    html += `<div class="alert-section-header">‚îÄ‚îÄ „Çª„É≥„ÉÅ„É°„É≥„ÉàÂàÜÊûê ‚îÄ‚îÄ</div>`;
    insiderAlerts.forEach(a => {
      if (a.sentiment_text) {
        const sColor = a.sentiment === 'up' ? 'var(--neon-green)' : a.sentiment === 'down' ? 'var(--neon-red)' : 'var(--dim-text)';
        html += `
          <div class="alert-item">
            <div style="font-size:11px;color:${sColor};">${a.sentiment_text}</div>
          </div>`;
      }
    });
  }

  // „Éá„Éº„Çø„Å™„Åó
  if (whaleAlerts.length === 0 && spoofingAlerts.length === 0 && insiderAlerts.length === 0) {
    html += `<div class="whale-error">„Åì„ÅÆÈäòÊüÑ„ÅÆ„Ç¢„É©„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì<br><span style="font-size:10px;">Ê¨°Âõû„Çπ„Ç≠„É£„É≥„ÅßÊ§úÂá∫„Åï„Çå„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô</span></div>`;
  }

  // „Çª„É≥„ÉÅ„É°„É≥„Éà„Éê„Éº
  const upC = sentiment.up || 0;
  const downC = sentiment.down || 0;
  const total = upC + downC;
  if (total > 0) {
    const bullPct = Math.round((upC / total) * 100);
    const bearPct = 100 - bullPct;
    const biasText = sentiment.bias === 'bullish' ? 'Âº∑Ê∞óÂÑ™Âã¢' : sentiment.bias === 'bearish' ? 'Âº±Ê∞óÂÑ™Âã¢' : '‰∏≠Á´ã';
    html += `
      <div class="sentiment-bar-wrap">
        <div class="sentiment-label">„Çª„É≥„ÉÅ„É°„É≥„Éà: ${biasText}</div>
        <div class="sentiment-bar">
          <div class="bull" style="width:${bullPct}%"></div>
          <div class="bear" style="width:${bearPct}%"></div>
        </div>
        <div class="sentiment-bar-labels">
          <span style="color:var(--neon-green);">Âº∑Ê∞ó ${bullPct}%</span>
          <span style="color:var(--neon-red);">Âº±Ê∞ó ${bearPct}%</span>
        </div>
      </div>`;
  }

  timeline.innerHTML = html;

  // ÂÜÜ„Ç∞„É©„Éï
  renderWhalePie(stats);
}

function renderWhalePie(stats) {
  const pieCanvas = document.getElementById('alertsPieCanvas');
  if (pieChart) {
    pieChart.destroy();
    pieChart = null;
  }

  const labels = ['„Ç™„Éó„Ç∑„Éß„É≥Áï∞Â∏∏', 'Áï∞Â∏∏Êùø„ÉªË¶ã„ÅõÊùø', '„Çª„É≥„ÉÅ„É°„É≥„Éà'];
  const values = [stats.whale_options || 0, stats.spoofing_walls || 0, stats.insider || 0];
  const colors = ['#00FF41', '#FF8800', '#00E5FF'];

  if (values.every(v => v === 0)) return;

  pieChart = new Chart(pieCanvas, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: '#1A1A25',
        borderWidth: 2,
      }],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            color: '#E0E0E0',
            font: { size: 9, family: "'Consolas', monospace" },
            padding: 6,
            boxWidth: 10,
          },
        },
      },
    },
  });
}

// ============================================
// Ticker Config Overlay
// ============================================
function openTickerConfig() {
  renderTickerConfigList();
  document.getElementById('tkcfgMsg').textContent = '';
  document.getElementById('tkcfgMsg').className = 'tkcfg-msg';
  document.getElementById('tkcfgInput').value = '';
  document.getElementById('tkcfgOverlay').classList.add('show');
  document.getElementById('tkcfgInput').focus();
}

function closeTickerConfig() {
  document.getElementById('tkcfgOverlay').classList.remove('show');
}

function renderTickerConfigList() {
  const list = document.getElementById('tkcfgList');
  list.innerHTML = '';
  for (const sym of tickerList) {
    const item = document.createElement('div');
    item.className = 'tkcfg-item';
    item.innerHTML =
      '<span class="tkcfg-item-name">' + sym + '</span>' +
      '<button class="tkcfg-del" data-sym="' + sym + '">\u2715 ÂâäÈô§</button>';
    item.querySelector('.tkcfg-del').onclick = function() { removeTickerConfig(sym); };
    list.appendChild(item);
  }
  document.getElementById('tkcfgCount').innerHTML =
    'Áõ£Ë¶ñ‰∏≠: <span class="cy">' + tickerList.length + '</span> ÈäòÊüÑ';
}

async function addTickerFromInput() {
  const input = document.getElementById('tkcfgInput');
  const ticker = input.value.trim().toUpperCase();
  if (!ticker) return;
  const msg = document.getElementById('tkcfgMsg');
  msg.textContent = ticker + ' „ÇíËøΩÂä†‰∏≠...';
  msg.className = 'tkcfg-msg';
  try {
    const res = await fetch(API + '/api/tickers/add', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker }),
    });
    const data = await res.json();
    if (data.ok) {
      tickerList = data.tickerList;
      msg.textContent = '\u2705 ' + ticker + ' „ÇíËøΩÂä†„Åó„Åæ„Åó„Åü';
      msg.className = 'tkcfg-msg ok';
      input.value = '';
      renderTickerConfigList();
      loadTickers();
    } else {
      msg.textContent = '\u26A0 ' + (data.error || 'ËøΩÂä†Â§±Êïó');
      msg.className = 'tkcfg-msg err';
    }
  } catch (e) {
    msg.textContent = '\u274C Êé•Á∂ö„Ç®„É©„Éº';
    msg.className = 'tkcfg-msg err';
  }
}

async function removeTickerConfig(sym) {
  const msg = document.getElementById('tkcfgMsg');
  msg.textContent = sym + ' „ÇíÂâäÈô§‰∏≠...';
  msg.className = 'tkcfg-msg';
  try {
    const res = await fetch(API + '/api/tickers/remove', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker: sym }),
    });
    const data = await res.json();
    if (data.ok) {
      tickerList = data.tickerList;
      msg.textContent = '\u2705 ' + sym + ' „ÇíÂâäÈô§„Åó„Åæ„Åó„Åü';
      msg.className = 'tkcfg-msg ok';
      renderTickerConfigList();
      tickersData = tickersData.filter(t => t.symbol !== sym);
      renderGrid();
    } else {
      msg.textContent = '\u26A0 ' + (data.error || 'ÂâäÈô§Â§±Êïó');
      msg.className = 'tkcfg-msg err';
    }
  } catch (e) {
    msg.textContent = '\u274C Êé•Á∂ö„Ç®„É©„Éº';
    msg.className = 'tkcfg-msg err';
  }
}

// ============================================
// Auto-refresh
// ============================================
function startRefresh() {
  loadTickers();
  refreshTimer = setInterval(loadTickers, 15000);
}

// ============================================
// Init
// ============================================
startRefresh();

// URL„Éë„É©„É°„Éº„Çø ?ticker=XXX „ÅßÁõ¥Êé•ÈäòÊüÑË©≥Á¥∞„ÇíÈñã„Åè
(async function() {
  const params = new URLSearchParams(window.location.search);
  const ticker = (params.get('ticker') || '').toUpperCase();
  if (ticker) {
    // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å£„Å¶„Åã„ÇâË©≥Á¥∞„ÇíÈñã„Åè
    const wait = () => new Promise(resolve => {
      const check = () => tickersData.length > 0 ? resolve() : setTimeout(check, 200);
      check();
    });
    await wait();
    showDetail(ticker);
  }
})();
</script>
</body>
</html>
